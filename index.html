<!DOCTYPE html>
<html>
<head>
    <!-- This title is not used. -->
    <title>Schedule Publish Folder</title> 
    
	<!-- Use Bootstrap to match the look of OU Campus. -->
	<link rel="stylesheet" href="../lib/bootstrap.min.css">

	<style type="text/css">
		body {
			margin: 10px;
			background-color: transparent;
		}
		.row {
			margin-left: 0px;
			margin-right: 0px;
		}
		#done-status {
			width: 100%;
			height: 100%;
			background: rgb(0,0,0,.7);
			position: absolute;
			z-index: 1;
			display: none;
			top: 0;
			left: 0;
		}
		.overwrite-container {
			background: white;
			margin: 20px;
			padding: 20px;
		}
	</style>

	<!-- jQuery IS REQUIRED for gadgetlib.js to work. -->
	<script type="text/javascript" src="../lib/jquery-2.1.3.min.js"></script>

	<!-- 
gadgetlib.js is a library of basic functions that gadgets can use. It creates a global
`gadget` object that has a few useful methods. (See comments in gadgetlib.js.)
-->
	<script type="text/javascript" src="../lib/gadgetlib.min.js"></script>

	<script type="text/javascript">

		$(document).ready(function () {
			function closeDisplay() {
				document.querySelector('#done-status').style.display = 'none';
			}
			function getFiles () {
				gadget.ready().then(gadget.fetch).then(function () {
					gadget.oucGetCurrentLocation().then(function(payload_data){
						const currentFolder = payload_data.hash.split('staging')[1];
						$.ajax({
							type : "GET",
							url : gadget.apihost + "/files/list",
							data : {
								authorization_token : gadget.token,
								path : currentFolder,
								site : gadget.site
							}
						}).done(data => scheduleFiles(data)).fail(() => console.log('error getting list'));
					});
				});
			}
			function scheduleFiles(e) {
				const files = e.entries;
				const formDate = $("#date-input").val();
				const formTime = $("#time-input").val();
				if (formDate === "" || formTime === "" || $("#repeat-cycle").val() === "" || $("#repeat-period").val() === "") {
					return
				}
				const utcTime = `${formDate}T${formTime}Z`;
				let count = 0;
				let items = 0;
				document.querySelector('#done-status').style.display = 'block';
				files.forEach(element => {
					items++;
					const status = function () {
						if (items === files.length) {
							$("#done-status").html(`<div class='overwrite-container'><p>${count} file(s) successfuly scheduled to publish</p><p>refresh page to see scheduling</p><button id="okay" type="button" class="btn btn-success">ok!</button></div>`);
							$('#okay').click(closeDisplay);
						}
					}
					if (element.file_type !== 'dir') {
						$.ajax({
							type : "POST",
							url : gadget.apihost + "/scheduledpublishes/new",
							data : {
								authorization_token : gadget.token,
								site : gadget.site,
								path : element.staging_path,
								target : /* enter your own site target here as a string */,
								date : utcTime,
								repeat_period : $("#repeat-period").val(),
								repeat_cycle : $("#repeat-cycle").val(),
								send_msg: true,
								include_unpublished : true
							}
						}).done(function() {
							count++
							$("#done-status").html(`<p>${count} file(s) scheduled`);
							status()
						}).fail(function() {
							console.log('error scheduling file');
							status()
						});
					}
					document.getElementById("schedule-folder").reset();
				});
			};
			$('#get-info').click(getFiles);
		});

		$(gadget).on({
			'expanded': function (evt) {
				// This event is triggered when the user expands (makes visible) a sidebar gadget.
                console.log('Gadget expanded.');
            },
            'collapsed': function (evt) {
                // This event is triggered when the user collapses (hides) a sidebar gadget.
                console.log('Gadget collapsed.');
            },
            'configuration': function (evt, config) {
                // If the user changes the gadget's configuration through the configuration modal,
                // the gadget will hear about it and get the new config in the data argument here.
                console.log('New config:', config);
                $('#main').css({ 'font-size': config.font_size });
            },
            'notification': function (evt, notification) {
                // If the gadget's config.xml contains a "notification" entry, any notifications
                // of the specified type(s) generated by OU Campus will trigger 'notification'
                // events that can be handled here.
                console.log('Notification received:', notification);
            }
        });
        
    </script>
	</head>
	<body>
		<div id="main">
			<div id="done-status">
			</div>
			<form id="schedule-folder" onsubmit="event.preventDefault()">
				<div class="form-group">
					<label for="date-input">Date</label>
					<input type="date" id="date-input" class="form-control" pattern="\d{4}-\d{2}-\d{2}" required/>
				</div>
				<div class="form-group">
					<label for="time-input">Time</label>
					<input type="time" id="time-input" class="form-control" required/>
				</div>
				<div class="form-group">
					<label for="repeat-cycle">Repeats Every</label>
					<div class="form-group row">
						<input class="form-control" type="number" value="1" id="repeat-cycle" min="1" max="999" required style="width:30%">
						<label for="repeat-period" style="visibility:hidden;line-height:0px;display:block;width:0px">Repeats Every</label>
						<select class="form-control" id="repeat-period" style="width:70%" required>
							<option value="d">Days</option>
							<option value="w">Weeks</option>
							<option value="m">Months</option>
							<option value="y">Years</option>
						</select>
					</div>
				</div>
				<div class="form-group">
					<button type="submit" id="get-info" class="btn btn-primary">Schedule Files in Current Folder</button>
				</div>
			</form>
		</div>
		<!--
        The following hidden div is only needed if you'll be editing your gadget in
        OU Campus's source code editor. OU Campus automatically adds a DirectEdit link
        to HTML files that you edit in OU Campus. This div hides the DirectEdit link.
    -->
    <div style="display:none">
        <a id="de" href="https://a.cms.omniupdate.com/10?skin=oucampus&amp;account=wcu&amp;site=wcu&amp;action=de&amp;path=/custom_gadgets/schedule-folder/index.html" style="text-decoration:none;" >Office of Web Services</a>
    </div>
</body>
</html>
